{% extends 'base.html.twig' %}

{% block stylesheets %}
	{{ parent() }}
	<link href="{{ asset('css/swac-recorder.css') }}" rel="stylesheet" />
{% endblock %}

{% block javascript %}
	{{ parent() }}
	<script type="text/javascript" src="{{ asset('js/ajax.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/buffer.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/buffers.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/sound.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/soundWidget.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/player.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/recorder.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/recorderWidget.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/swac-recorder/audioAuthWidget.js') }}"></script>

	<script type="text/javascript">
		var App = function() {
			this.nodeSpeaker = document.getElementById("speaker");
			this.nodeLang = document.getElementById("lang");
			this.targetUrl = "{{ path('soundsApi') }}";
			this.ajax = new Ajax();
			this.audioAuthWidget = new AudioAuthWidget();
			this.node = this.audioAuthWidget.node;
			this.init();
		};

		App.prototype.init = function() {
			var self = this;
			this.audioAuthWidget.onenabled = function(stream) {
				var recorderWidget = new RecorderWidget(stream, function(sound, meta, doneCb) { self.send(sound, meta, doneCb) } );
				this.appendChild(recorderWidget.node);
			};
			this.setDefaultLang();
		};

		App.prototype.send = function send(sound, meta, doneCb) {
			var formData = new FormData();
			formData.append("user", {{ user.getId() }});
			formData.append("sound", sound.getBlob());
			formData.append("text", meta.transcript);
			formData.append("description", meta.description);
			formData.append("speaker", document.getElementById("speaker").value);
			formData.append("lang", document.getElementById("lang").value);
			this.ajax.querySendData(this.targetUrl, "post", formData, function(result) {
				console.log(JSON.stringify(result));
				doneCb(result);
			}, false);
		};

		App.prototype.setDefaultLang = function() {
			var lang = this.nodeSpeaker.childNodes[this.nodeSpeaker.selectedIndex].getAttribute("lang");
			if (lang) this.nodeLang.value = lang;
		};

		var app = null;
		window.onload = function() {
			app = new App();
			document.getElementById("container").appendChild(app.node);
		};
	</script>
{% endblock %}

{% block body %}
	<h1>Studio d’enregistrement</h1>
	{% if speakers|length == 0 %}
		<p>Pour procéder à l’enregistrement vous devez <a href="{{ path("usersAddSpeaker", {"id": user.getId() }) }}">créer un profil de locuteur</a>.</p>
	{% else %}
		<table class="nice">
			<tr>
				<th>Locuteur</th>
				<td>
					<select id="speaker" onchange="app.setDefaultLang()">{% for speaker in speakers %}<option value="{{ speaker.getId() }}" {% if speaker.getDefaultLanguage() %}lang="{{ speaker.getDefaultLanguage().getLanguage().getId() }}"{% endif %}>{{ speaker.getName() }}</option>{% endfor %}</select>
				</td>
				<th>
					<a href="{{ path("usersAddSpeaker", {"id": user.getId() }) }}"><img src="{{ asset("img/add_24.png") }}" title="Ajouter un locuteur"/></a>
				</th>
			</tr>
			<tr>
				<th>Langue</th>
				<td>
					<select id="lang">
						<option value="">- Veuillez choisir une langue -</option>
						{% for language in languages %}
						<option value="{{ language.getId() }}">{{ language.getTitle() }}</option>
						{% endfor %}
					</select>
				</td>
			</tr>
		</table>

		<div id="container"></div>
	{% endif %}
{% endblock %}

